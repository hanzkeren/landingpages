{"version":3,"sources":["../../../src/lib/vite-plugins/build-metadata.ts"],"sourcesContent":["import assert from 'node:assert/strict';\nimport fs from 'node:fs';\nimport { mkdir, writeFile } from 'node:fs/promises';\nimport path from 'node:path';\nimport { Readable } from 'node:stream';\nimport { pipeline } from 'node:stream/promises';\nimport { pathToFileURL } from 'node:url';\nimport pc from 'picocolors';\nimport { type Plugin, normalizePath } from 'vite';\nimport { BUILD_METADATA_FILE, DIST_SERVER } from '../constants.js';\nimport { joinPath } from '../utils/path.js';\nimport { createProgressLogger } from '../utils/progress-logger.js';\n\nconst forceRelativePath = (s: string) => (s.startsWith('.') ? s : './' + s);\n\nexport function buildMetadataPlugin({ distDir }: { distDir: string }): Plugin {\n  const virtualModule = 'virtual:vite-rsc-waku/build-metadata';\n  const dummySource = 'export const buildMetadata = new Map();';\n  return {\n    name: 'waku:vite-plugins:build-metadata',\n    resolveId(source, _importer, _options) {\n      if (source === virtualModule) {\n        assert.equal(this.environment.name, 'rsc');\n        if (this.environment.mode === 'build') {\n          return { id: source, external: true, moduleSideEffects: true };\n        }\n        return '\\0' + virtualModule;\n      }\n    },\n    load(id) {\n      if (id === '\\0' + virtualModule) {\n        // no-op during dev\n        assert.equal(this.environment.mode, 'dev');\n        return dummySource;\n      }\n    },\n    renderChunk(code, chunk) {\n      if (code.includes(virtualModule)) {\n        assert.equal(this.environment.name, 'rsc');\n        const replacement = forceRelativePath(\n          normalizePath(\n            path.relative(path.join(chunk.fileName, '..'), BUILD_METADATA_FILE),\n          ),\n        );\n        return code.replaceAll(virtualModule, () => replacement);\n      }\n    },\n    buildApp: {\n      async handler(builder) {\n        const viteConfig = builder.config;\n        const rootDir = viteConfig.root;\n        const buildMetadataFile = joinPath(\n          rootDir,\n          distDir,\n          DIST_SERVER,\n          BUILD_METADATA_FILE,\n        );\n        await writeFile(buildMetadataFile, dummySource);\n\n        const progress = createProgressLogger();\n        const emitFile = async (\n          filePath: string,\n          body: ReadableStream | string,\n        ) => {\n          const destFile = joinPath(rootDir, distDir, filePath);\n          if (!destFile.startsWith(rootDir)) {\n            throw new Error('Invalid filePath: ' + filePath);\n          }\n          // In partial mode, skip if the file already exists.\n          if (\n            fs.existsSync(destFile) &&\n            // HACK: This feels a bit hacky\n            destFile !== buildMetadataFile\n          ) {\n            return;\n          }\n          progress.update(`generating a file ${pc.dim(filePath)}`);\n          await mkdir(joinPath(destFile, '..'), { recursive: true });\n          if (typeof body === 'string') {\n            await writeFile(destFile, body);\n          } else {\n            await pipeline(\n              Readable.fromWeb(body as never),\n              fs.createWriteStream(destFile),\n            );\n          }\n        };\n        const entryPath = path.join(\n          viteConfig.environments.rsc!.build.outDir,\n          'build.js',\n        );\n        console.log(pc.blue('[ssg] processing static generation...'));\n        const startTime = performance.now();\n        const entry: typeof import('../vite-entries/entry.build.js') =\n          await import(pathToFileURL(entryPath).href);\n        await entry.INTERNAL_runBuild({ rootDir, emitFile });\n        progress.done();\n        const fileCount = progress.getCount();\n        console.log(\n          pc.green(\n            `âœ“ ${fileCount} file${fileCount !== 1 ? 's' : ''} generated in ${Math.ceil(performance.now() - startTime)}ms`,\n          ),\n        );\n      },\n    },\n  };\n}\n"],"names":["assert","fs","mkdir","writeFile","path","Readable","pipeline","pathToFileURL","pc","normalizePath","BUILD_METADATA_FILE","DIST_SERVER","joinPath","createProgressLogger","forceRelativePath","s","startsWith","buildMetadataPlugin","distDir","virtualModule","dummySource","name","resolveId","source","_importer","_options","equal","environment","mode","id","external","moduleSideEffects","load","renderChunk","code","chunk","includes","replacement","relative","join","fileName","replaceAll","buildApp","handler","builder","viteConfig","config","rootDir","root","buildMetadataFile","progress","emitFile","filePath","body","destFile","Error","existsSync","update","dim","recursive","fromWeb","createWriteStream","entryPath","environments","rsc","build","outDir","console","log","blue","startTime","performance","now","entry","href","INTERNAL_runBuild","done","fileCount","getCount","green","Math","ceil"],"mappings":"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"}