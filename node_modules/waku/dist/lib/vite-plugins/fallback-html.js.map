{"version":3,"sources":["../../../src/lib/vite-plugins/fallback-html.ts"],"sourcesContent":["import assert from 'node:assert/strict';\nimport fs from 'node:fs';\nimport path from 'node:path';\nimport type { Plugin, ViteDevServer } from 'vite';\n\nexport function fallbackHtmlPlugin(): Plugin {\n  let server: ViteDevServer | undefined;\n  return {\n    name: 'waku:vite-plugins:fallback-html',\n    config() {\n      return {\n        environments: {\n          client: {\n            build: {\n              rollupOptions: {\n                input: {\n                  indexHtml: 'index.html',\n                },\n              },\n            },\n          },\n        },\n      };\n    },\n    configureServer(server_) {\n      server = server_;\n    },\n    async resolveId(source, _importer, _options) {\n      if (source === 'index.html') {\n        // this resolve is called as fallback only when Vite didn't find an actual file `index.html`\n        // we need to keep exact same name to have `index.html` as an output file.\n        assert(this.environment.name === 'client');\n        assert(this.environment.mode === 'build');\n        return source;\n      }\n      if (source === 'virtual:vite-rsc-waku/fallback-html') {\n        assert(this.environment.name === 'ssr');\n        return { id: '\\0' + source, moduleSideEffects: true };\n      }\n    },\n    async load(id) {\n      if (id === 'index.html') {\n        return `<html><body></body></html>`;\n      }\n      if (id === '\\0virtual:vite-rsc-waku/fallback-html') {\n        let html = `<html><body></body></html>`;\n        if (this.environment.mode === 'dev') {\n          if (fs.existsSync('index.html')) {\n            // TODO: inline script not invalidated propery?\n            this.addWatchFile(path.resolve('index.html'));\n            html = fs.readFileSync('index.html', 'utf-8');\n            html = await server!.transformIndexHtml('/', html);\n          }\n        } else {\n          // skip during scan build\n          if (this.environment.config.build.write) {\n            const config = this.environment.getTopLevelConfig();\n            const file = path.join(\n              config.environments.client!.build.outDir,\n              'index.html',\n            );\n            html = fs.readFileSync(file, 'utf-8');\n            // remove index.html from the build to avoid default preview server serving it\n            fs.rmSync(file);\n          }\n        }\n        return `export default ${JSON.stringify(html)};`;\n      }\n    },\n  };\n}\n"],"names":["assert","fs","path","fallbackHtmlPlugin","server","name","config","environments","client","build","rollupOptions","input","indexHtml","configureServer","server_","resolveId","source","_importer","_options","environment","mode","id","moduleSideEffects","load","html","existsSync","addWatchFile","resolve","readFileSync","transformIndexHtml","write","getTopLevelConfig","file","join","outDir","rmSync","JSON","stringify"],"mappings":"AAAA,OAAOA,YAAY,qBAAqB;AACxC,OAAOC,QAAQ,UAAU;AACzB,OAAOC,UAAU,YAAY;AAG7B,OAAO,SAASC;IACd,IAAIC;IACJ,OAAO;QACLC,MAAM;QACNC;YACE,OAAO;gBACLC,cAAc;oBACZC,QAAQ;wBACNC,OAAO;4BACLC,eAAe;gCACbC,OAAO;oCACLC,WAAW;gCACb;4BACF;wBACF;oBACF;gBACF;YACF;QACF;QACAC,iBAAgBC,OAAO;YACrBV,SAASU;QACX;QACA,MAAMC,WAAUC,MAAM,EAAEC,SAAS,EAAEC,QAAQ;YACzC,IAAIF,WAAW,cAAc;gBAC3B,4FAA4F;gBAC5F,0EAA0E;gBAC1EhB,OAAO,IAAI,CAACmB,WAAW,CAACd,IAAI,KAAK;gBACjCL,OAAO,IAAI,CAACmB,WAAW,CAACC,IAAI,KAAK;gBACjC,OAAOJ;YACT;YACA,IAAIA,WAAW,uCAAuC;gBACpDhB,OAAO,IAAI,CAACmB,WAAW,CAACd,IAAI,KAAK;gBACjC,OAAO;oBAAEgB,IAAI,OAAOL;oBAAQM,mBAAmB;gBAAK;YACtD;QACF;QACA,MAAMC,MAAKF,EAAE;YACX,IAAIA,OAAO,cAAc;gBACvB,OAAO,CAAC,0BAA0B,CAAC;YACrC;YACA,IAAIA,OAAO,yCAAyC;gBAClD,IAAIG,OAAO,CAAC,0BAA0B,CAAC;gBACvC,IAAI,IAAI,CAACL,WAAW,CAACC,IAAI,KAAK,OAAO;oBACnC,IAAInB,GAAGwB,UAAU,CAAC,eAAe;wBAC/B,+CAA+C;wBAC/C,IAAI,CAACC,YAAY,CAACxB,KAAKyB,OAAO,CAAC;wBAC/BH,OAAOvB,GAAG2B,YAAY,CAAC,cAAc;wBACrCJ,OAAO,MAAMpB,OAAQyB,kBAAkB,CAAC,KAAKL;oBAC/C;gBACF,OAAO;oBACL,yBAAyB;oBACzB,IAAI,IAAI,CAACL,WAAW,CAACb,MAAM,CAACG,KAAK,CAACqB,KAAK,EAAE;wBACvC,MAAMxB,SAAS,IAAI,CAACa,WAAW,CAACY,iBAAiB;wBACjD,MAAMC,OAAO9B,KAAK+B,IAAI,CACpB3B,OAAOC,YAAY,CAACC,MAAM,CAAEC,KAAK,CAACyB,MAAM,EACxC;wBAEFV,OAAOvB,GAAG2B,YAAY,CAACI,MAAM;wBAC7B,8EAA8E;wBAC9E/B,GAAGkC,MAAM,CAACH;oBACZ;gBACF;gBACA,OAAO,CAAC,eAAe,EAAEI,KAAKC,SAAS,CAACb,MAAM,CAAC,CAAC;YAClD;QACF;IACF;AACF"}