{"version":3,"sources":["../../../src/lib/vite-plugins/main.ts"],"sourcesContent":["import path from 'node:path';\nimport { fileURLToPath } from 'node:url';\nimport type { Plugin, RunnableDevEnvironment, UserConfig } from 'vite';\nimport { mergeConfig } from 'vite';\nimport type { Config } from '../../config.js';\nimport {\n  DIST_PUBLIC,\n  DIST_SERVER,\n  SRC_CLIENT_ENTRY,\n  SRC_PAGES,\n  SRC_SERVER_ENTRY,\n} from '../constants.js';\n\nconst PKG_NAME = 'waku';\nconst __dirname = fileURLToPath(new URL('.', import.meta.url));\n\nexport function mainPlugin(config: Required<Config>): Plugin {\n  return {\n    name: 'waku:vite-plugins:main',\n    async config(_config) {\n      let viteRscConfig: UserConfig = {\n        base: config.basePath,\n        define: {\n          'process.env.NODE_ENV': JSON.stringify(process.env.NODE_ENV),\n          'import.meta.env.WAKU_CONFIG_BASE_PATH': JSON.stringify(\n            config.basePath,\n          ),\n          'import.meta.env.WAKU_CONFIG_RSC_BASE': JSON.stringify(\n            config.rscBase,\n          ),\n          // CLI has loaded dotenv already at this point\n          ...Object.fromEntries(\n            Object.entries(process.env).flatMap(([k, v]) =>\n              k.startsWith('WAKU_PUBLIC_')\n                ? [\n                    [`import.meta.env.${k}`, JSON.stringify(v)],\n                    // TODO: defining `process.env` on client dev is not recommended.\n                    // see https://github.com/vitest-dev/vitest/pull/6718\n                    [`process.env.${k}`, JSON.stringify(v)],\n                  ]\n                : [],\n            ),\n          ),\n        },\n        environments: {\n          client: {\n            build: {\n              rollupOptions: {\n                input: {\n                  index: path.join(\n                    __dirname,\n                    '../vite-entries/entry.browser.js',\n                  ),\n                },\n              },\n            },\n            optimizeDeps: {\n              entries: [\n                `${config.srcDir}/${SRC_CLIENT_ENTRY}.*`,\n                `${config.srcDir}/${SRC_SERVER_ENTRY}.*`,\n                `${config.srcDir}/${SRC_PAGES}/**/*.*`,\n              ],\n            },\n          },\n          ssr: {\n            build: {\n              rollupOptions: {\n                input: {\n                  index: path.join(__dirname, '../vite-entries/entry.ssr.js'),\n                },\n              },\n            },\n          },\n          rsc: {\n            build: {\n              rollupOptions: {\n                input: {\n                  index: path.join(\n                    __dirname,\n                    '../vite-entries/entry.server.js',\n                  ),\n                  build: path.join(__dirname, '../vite-entries/entry.build.js'),\n                },\n              },\n            },\n          },\n        },\n      };\n\n      if (config.vite) {\n        viteRscConfig = mergeConfig(viteRscConfig, {\n          ...config.vite,\n          plugins: undefined,\n        });\n      }\n\n      return viteRscConfig;\n    },\n    configEnvironment(name, environmentConfig, env) {\n      // make @vitejs/plugin-rsc usable as a transitive dependency\n      // by rewriting `optimizeDeps.include`. e.g.\n      // include: [\"@vitejs/plugin-rsc/vendor/xxx\", \"@vitejs/plugin-rsc > yyy\"]\n      // â‡“\n      // include: [\"waku > @vitejs/plugin-rsc/vendor/xxx\", \"waku > @vitejs/plugin-rsc > yyy\"]\n      if (environmentConfig.optimizeDeps?.include) {\n        environmentConfig.optimizeDeps.include =\n          environmentConfig.optimizeDeps.include.map((name) => {\n            if (name.startsWith('@vitejs/plugin-rsc')) {\n              name = `${PKG_NAME} > ${name}`;\n            }\n            return name;\n          });\n      }\n\n      environmentConfig.build ??= {};\n      environmentConfig.build.outDir = `${config.distDir}/${name}`;\n      if (name === 'rsc') {\n        environmentConfig.build.outDir = `${config.distDir}/${DIST_SERVER}`;\n      }\n      if (name === 'ssr') {\n        environmentConfig.build.outDir = `${config.distDir}/${DIST_SERVER}/ssr`;\n      }\n      if (name === 'client') {\n        environmentConfig.build.outDir = `${config.distDir}/${DIST_PUBLIC}`;\n      }\n\n      return {\n        resolve: {\n          noExternal: env.command === 'build' ? true : [PKG_NAME],\n        },\n        optimizeDeps: {\n          exclude: [PKG_NAME, 'waku/minimal/client', 'waku/router/client'],\n        },\n      };\n    },\n    async configureServer(server) {\n      const { getRequestListener } = await import('@hono/node-server');\n      const environment = server.environments.rsc! as RunnableDevEnvironment;\n      const entryId = (environment.config.build.rollupOptions.input as any)\n        .index;\n      return () => {\n        server.middlewares.use(async (req, res, next) => {\n          try {\n            // Restore Vite's automatically stripped base\n            req.url = req.originalUrl;\n            const mod: typeof import('../vite-entries/entry.server.js') =\n              await environment.runner.import(entryId);\n            await getRequestListener((req, ...args) =>\n              mod.INTERNAL_runFetch(process.env as any, req, ...args),\n            )(req, res);\n          } catch (e) {\n            next(e);\n          }\n        });\n      };\n    },\n  };\n}\n"],"names":["path","fileURLToPath","mergeConfig","DIST_PUBLIC","DIST_SERVER","SRC_CLIENT_ENTRY","SRC_PAGES","SRC_SERVER_ENTRY","PKG_NAME","__dirname","URL","url","mainPlugin","config","name","_config","viteRscConfig","base","basePath","define","JSON","stringify","process","env","NODE_ENV","rscBase","Object","fromEntries","entries","flatMap","k","v","startsWith","environments","client","build","rollupOptions","input","index","join","optimizeDeps","srcDir","ssr","rsc","vite","plugins","undefined","configEnvironment","environmentConfig","include","map","outDir","distDir","resolve","noExternal","command","exclude","configureServer","server","getRequestListener","environment","entryId","middlewares","use","req","res","next","originalUrl","mod","runner","import","args","INTERNAL_runFetch","e"],"mappings":"AAAA,OAAOA,UAAU,YAAY;AAC7B,SAASC,aAAa,QAAQ,WAAW;AAEzC,SAASC,WAAW,QAAQ,OAAO;AAEnC,SACEC,WAAW,EACXC,WAAW,EACXC,gBAAgB,EAChBC,SAAS,EACTC,gBAAgB,QACX,kBAAkB;AAEzB,MAAMC,WAAW;AACjB,MAAMC,YAAYR,cAAc,IAAIS,IAAI,KAAK,YAAYC,GAAG;AAE5D,OAAO,SAASC,WAAWC,MAAwB;IACjD,OAAO;QACLC,MAAM;QACN,MAAMD,QAAOE,OAAO;YAClB,IAAIC,gBAA4B;gBAC9BC,MAAMJ,OAAOK,QAAQ;gBACrBC,QAAQ;oBACN,wBAAwBC,KAAKC,SAAS,CAACC,QAAQC,GAAG,CAACC,QAAQ;oBAC3D,yCAAyCJ,KAAKC,SAAS,CACrDR,OAAOK,QAAQ;oBAEjB,wCAAwCE,KAAKC,SAAS,CACpDR,OAAOY,OAAO;oBAEhB,8CAA8C;oBAC9C,GAAGC,OAAOC,WAAW,CACnBD,OAAOE,OAAO,CAACN,QAAQC,GAAG,EAAEM,OAAO,CAAC,CAAC,CAACC,GAAGC,EAAE,GACzCD,EAAEE,UAAU,CAAC,kBACT;4BACE;gCAAC,CAAC,gBAAgB,EAAEF,GAAG;gCAAEV,KAAKC,SAAS,CAACU;6BAAG;4BAC3C,iEAAiE;4BACjE,qDAAqD;4BACrD;gCAAC,CAAC,YAAY,EAAED,GAAG;gCAAEV,KAAKC,SAAS,CAACU;6BAAG;yBACxC,GACD,EAAE,EAET;gBACH;gBACAE,cAAc;oBACZC,QAAQ;wBACNC,OAAO;4BACLC,eAAe;gCACbC,OAAO;oCACLC,OAAOtC,KAAKuC,IAAI,CACd9B,WACA;gCAEJ;4BACF;wBACF;wBACA+B,cAAc;4BACZZ,SAAS;gCACP,GAAGf,OAAO4B,MAAM,CAAC,CAAC,EAAEpC,iBAAiB,EAAE,CAAC;gCACxC,GAAGQ,OAAO4B,MAAM,CAAC,CAAC,EAAElC,iBAAiB,EAAE,CAAC;gCACxC,GAAGM,OAAO4B,MAAM,CAAC,CAAC,EAAEnC,UAAU,OAAO,CAAC;6BACvC;wBACH;oBACF;oBACAoC,KAAK;wBACHP,OAAO;4BACLC,eAAe;gCACbC,OAAO;oCACLC,OAAOtC,KAAKuC,IAAI,CAAC9B,WAAW;gCAC9B;4BACF;wBACF;oBACF;oBACAkC,KAAK;wBACHR,OAAO;4BACLC,eAAe;gCACbC,OAAO;oCACLC,OAAOtC,KAAKuC,IAAI,CACd9B,WACA;oCAEF0B,OAAOnC,KAAKuC,IAAI,CAAC9B,WAAW;gCAC9B;4BACF;wBACF;oBACF;gBACF;YACF;YAEA,IAAII,OAAO+B,IAAI,EAAE;gBACf5B,gBAAgBd,YAAYc,eAAe;oBACzC,GAAGH,OAAO+B,IAAI;oBACdC,SAASC;gBACX;YACF;YAEA,OAAO9B;QACT;QACA+B,mBAAkBjC,IAAI,EAAEkC,iBAAiB,EAAEzB,GAAG;YAC5C,4DAA4D;YAC5D,4CAA4C;YAC5C,yEAAyE;YACzE,IAAI;YACJ,uFAAuF;YACvF,IAAIyB,kBAAkBR,YAAY,EAAES,SAAS;gBAC3CD,kBAAkBR,YAAY,CAACS,OAAO,GACpCD,kBAAkBR,YAAY,CAACS,OAAO,CAACC,GAAG,CAAC,CAACpC;oBAC1C,IAAIA,KAAKkB,UAAU,CAAC,uBAAuB;wBACzClB,OAAO,GAAGN,SAAS,GAAG,EAAEM,MAAM;oBAChC;oBACA,OAAOA;gBACT;YACJ;YAEAkC,kBAAkBb,KAAK,KAAK,CAAC;YAC7Ba,kBAAkBb,KAAK,CAACgB,MAAM,GAAG,GAAGtC,OAAOuC,OAAO,CAAC,CAAC,EAAEtC,MAAM;YAC5D,IAAIA,SAAS,OAAO;gBAClBkC,kBAAkBb,KAAK,CAACgB,MAAM,GAAG,GAAGtC,OAAOuC,OAAO,CAAC,CAAC,EAAEhD,aAAa;YACrE;YACA,IAAIU,SAAS,OAAO;gBAClBkC,kBAAkBb,KAAK,CAACgB,MAAM,GAAG,GAAGtC,OAAOuC,OAAO,CAAC,CAAC,EAAEhD,YAAY,IAAI,CAAC;YACzE;YACA,IAAIU,SAAS,UAAU;gBACrBkC,kBAAkBb,KAAK,CAACgB,MAAM,GAAG,GAAGtC,OAAOuC,OAAO,CAAC,CAAC,EAAEjD,aAAa;YACrE;YAEA,OAAO;gBACLkD,SAAS;oBACPC,YAAY/B,IAAIgC,OAAO,KAAK,UAAU,OAAO;wBAAC/C;qBAAS;gBACzD;gBACAgC,cAAc;oBACZgB,SAAS;wBAAChD;wBAAU;wBAAuB;qBAAqB;gBAClE;YACF;QACF;QACA,MAAMiD,iBAAgBC,MAAM;YAC1B,MAAM,EAAEC,kBAAkB,EAAE,GAAG,MAAM,MAAM,CAAC;YAC5C,MAAMC,cAAcF,OAAOzB,YAAY,CAACU,GAAG;YAC3C,MAAMkB,UAAU,AAACD,YAAY/C,MAAM,CAACsB,KAAK,CAACC,aAAa,CAACC,KAAK,CAC1DC,KAAK;YACR,OAAO;gBACLoB,OAAOI,WAAW,CAACC,GAAG,CAAC,OAAOC,KAAKC,KAAKC;oBACtC,IAAI;wBACF,6CAA6C;wBAC7CF,IAAIrD,GAAG,GAAGqD,IAAIG,WAAW;wBACzB,MAAMC,MACJ,MAAMR,YAAYS,MAAM,CAACC,MAAM,CAACT;wBAClC,MAAMF,mBAAmB,CAACK,KAAK,GAAGO,OAChCH,IAAII,iBAAiB,CAAClD,QAAQC,GAAG,EAASyC,QAAQO,OAClDP,KAAKC;oBACT,EAAE,OAAOQ,GAAG;wBACVP,KAAKO;oBACP;gBACF;YACF;QACF;IACF;AACF"}