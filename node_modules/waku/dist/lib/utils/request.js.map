{"version":3,"sources":["../../../src/lib/utils/request.ts"],"sourcesContent":["import type { ReactFormState } from 'react-dom/client';\nimport type { Config } from '../../config.js';\nimport type { Unstable_HandleRequest as HandleRequest } from '../types.js';\nimport { decodeFuncId, decodeRscPath } from '../utils/rsc-path.js';\nimport { removeBase } from './path.js';\n\ntype HandleRequestInput = Parameters<HandleRequest>[0];\n\nexport async function getInput(\n  req: Request,\n  config: Omit<Required<Config>, 'vite'>,\n  temporaryReferences: unknown,\n  decodeReply: (\n    body: string | FormData,\n    options?: unknown,\n  ) => Promise<unknown[]>,\n  decodeAction: (body: FormData) => Promise<() => Promise<void>>,\n  decodeFormState: (\n    actionResult: unknown,\n    body: FormData,\n  ) => Promise<ReactFormState | undefined>,\n  loadServerAction: (id: string) => Promise<unknown>,\n) {\n  const url = new URL(req.url);\n  url.pathname = removeBase(url.pathname, config.basePath);\n  const pathname = decodeURI(url.pathname);\n  const rscPathPrefix = '/' + config.rscBase + '/';\n  let rscPath: string | undefined;\n  let input: HandleRequestInput;\n  if (url.pathname.startsWith(rscPathPrefix)) {\n    rscPath = decodeRscPath(\n      decodeURI(url.pathname.slice(rscPathPrefix.length)),\n    );\n    // server action: js\n    const actionId = decodeFuncId(rscPath);\n    if (actionId) {\n      const body = await getActionBody(req);\n      const args = await decodeReply(body, { temporaryReferences });\n      const action = await loadServerAction(actionId);\n      input = {\n        type: 'function',\n        fn: action as any,\n        args,\n        pathname,\n        req,\n      };\n    } else {\n      // client RSC request\n      let rscParams: unknown = url.searchParams;\n      if (req.body) {\n        const body = await getActionBody(req);\n        rscParams = await decodeReply(body, {\n          temporaryReferences,\n        });\n      }\n      input = {\n        type: 'component',\n        rscPath,\n        rscParams,\n        pathname,\n        req,\n      };\n    }\n  } else if (req.method === 'POST') {\n    const contentType = req.headers.get('content-type');\n    if (\n      typeof contentType === 'string' &&\n      contentType.startsWith('multipart/form-data')\n    ) {\n      // server action: no js (progressive enhancement)\n      input = {\n        type: 'action',\n        fn: async () => {\n          const formData = (await getActionBody(req)) as FormData;\n          const decodedAction = await decodeAction(formData);\n          const result = await decodedAction();\n          return await decodeFormState(result, formData);\n        },\n        pathname,\n        req,\n      };\n    } else {\n      // POST API request\n      input = {\n        type: 'custom',\n        pathname,\n        req,\n      };\n    }\n  } else {\n    // SSR\n    input = {\n      type: 'custom',\n      pathname,\n      req,\n    };\n  }\n  return input;\n}\n\nasync function getActionBody(req: Request) {\n  if (!req.body) {\n    throw new Error('missing request body for server function');\n  }\n  const contentType = req.headers.get('content-type');\n  if (contentType?.startsWith('multipart/form-data')) {\n    return req.formData();\n  } else {\n    return req.text();\n  }\n}\n"],"names":["decodeFuncId","decodeRscPath","removeBase","getInput","req","config","temporaryReferences","decodeReply","decodeAction","decodeFormState","loadServerAction","url","URL","pathname","basePath","decodeURI","rscPathPrefix","rscBase","rscPath","input","startsWith","slice","length","actionId","body","getActionBody","args","action","type","fn","rscParams","searchParams","method","contentType","headers","get","formData","decodedAction","result","Error","text"],"mappings":"AAGA,SAASA,YAAY,EAAEC,aAAa,QAAQ,uBAAuB;AACnE,SAASC,UAAU,QAAQ,YAAY;AAIvC,OAAO,eAAeC,SACpBC,GAAY,EACZC,MAAsC,EACtCC,mBAA4B,EAC5BC,WAGuB,EACvBC,YAA8D,EAC9DC,eAGwC,EACxCC,gBAAkD;IAElD,MAAMC,MAAM,IAAIC,IAAIR,IAAIO,GAAG;IAC3BA,IAAIE,QAAQ,GAAGX,WAAWS,IAAIE,QAAQ,EAAER,OAAOS,QAAQ;IACvD,MAAMD,WAAWE,UAAUJ,IAAIE,QAAQ;IACvC,MAAMG,gBAAgB,MAAMX,OAAOY,OAAO,GAAG;IAC7C,IAAIC;IACJ,IAAIC;IACJ,IAAIR,IAAIE,QAAQ,CAACO,UAAU,CAACJ,gBAAgB;QAC1CE,UAAUjB,cACRc,UAAUJ,IAAIE,QAAQ,CAACQ,KAAK,CAACL,cAAcM,MAAM;QAEnD,oBAAoB;QACpB,MAAMC,WAAWvB,aAAakB;QAC9B,IAAIK,UAAU;YACZ,MAAMC,OAAO,MAAMC,cAAcrB;YACjC,MAAMsB,OAAO,MAAMnB,YAAYiB,MAAM;gBAAElB;YAAoB;YAC3D,MAAMqB,SAAS,MAAMjB,iBAAiBa;YACtCJ,QAAQ;gBACNS,MAAM;gBACNC,IAAIF;gBACJD;gBACAb;gBACAT;YACF;QACF,OAAO;YACL,qBAAqB;YACrB,IAAI0B,YAAqBnB,IAAIoB,YAAY;YACzC,IAAI3B,IAAIoB,IAAI,EAAE;gBACZ,MAAMA,OAAO,MAAMC,cAAcrB;gBACjC0B,YAAY,MAAMvB,YAAYiB,MAAM;oBAClClB;gBACF;YACF;YACAa,QAAQ;gBACNS,MAAM;gBACNV;gBACAY;gBACAjB;gBACAT;YACF;QACF;IACF,OAAO,IAAIA,IAAI4B,MAAM,KAAK,QAAQ;QAChC,MAAMC,cAAc7B,IAAI8B,OAAO,CAACC,GAAG,CAAC;QACpC,IACE,OAAOF,gBAAgB,YACvBA,YAAYb,UAAU,CAAC,wBACvB;YACA,iDAAiD;YACjDD,QAAQ;gBACNS,MAAM;gBACNC,IAAI;oBACF,MAAMO,WAAY,MAAMX,cAAcrB;oBACtC,MAAMiC,gBAAgB,MAAM7B,aAAa4B;oBACzC,MAAME,SAAS,MAAMD;oBACrB,OAAO,MAAM5B,gBAAgB6B,QAAQF;gBACvC;gBACAvB;gBACAT;YACF;QACF,OAAO;YACL,mBAAmB;YACnBe,QAAQ;gBACNS,MAAM;gBACNf;gBACAT;YACF;QACF;IACF,OAAO;QACL,MAAM;QACNe,QAAQ;YACNS,MAAM;YACNf;YACAT;QACF;IACF;IACA,OAAOe;AACT;AAEA,eAAeM,cAAcrB,GAAY;IACvC,IAAI,CAACA,IAAIoB,IAAI,EAAE;QACb,MAAM,IAAIe,MAAM;IAClB;IACA,MAAMN,cAAc7B,IAAI8B,OAAO,CAACC,GAAG,CAAC;IACpC,IAAIF,aAAab,WAAW,wBAAwB;QAClD,OAAOhB,IAAIgC,QAAQ;IACrB,OAAO;QACL,OAAOhC,IAAIoC,IAAI;IACjB;AACF"}