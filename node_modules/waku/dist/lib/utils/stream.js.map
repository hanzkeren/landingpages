{"version":3,"sources":["../../../src/lib/utils/stream.ts"],"sourcesContent":["// Utility functions for web streams (not Node.js streams)\n\nexport const stringToStream = (str: string): ReadableStream => {\n  const encoder = new TextEncoder();\n  return new ReadableStream({\n    start(controller) {\n      controller.enqueue(encoder.encode(str));\n      controller.close();\n    },\n  });\n};\n\nexport const streamToBase64 = async (\n  stream: ReadableStream,\n): Promise<string> => {\n  const reader = stream.getReader();\n  let binary = '';\n  let result: ReadableStreamReadResult<unknown>;\n  do {\n    result = await reader.read();\n    if (result.value) {\n      if (!(result.value instanceof Uint8Array)) {\n        throw new Error('Unexepected buffer type');\n      }\n      for (let i = 0; i < result.value.length; i++) {\n        binary += String.fromCharCode(result.value[i]!);\n      }\n    }\n  } while (!result.done);\n  return btoa(binary);\n};\n\nexport const base64ToStream = (base64: string): ReadableStream => {\n  const bytes = Uint8Array.from(atob(base64), (c) => c.charCodeAt(0));\n  return new Blob([bytes]).stream();\n};\n\nfunction concatUint8Array(chunks: readonly Uint8Array[]): Uint8Array {\n  if (chunks.length === 1) {\n    return chunks[0]!;\n  }\n  const total = chunks.reduce((n, chunk) => n + chunk.byteLength, 0);\n  const out = new Uint8Array(total);\n  let offset = 0;\n  for (const chunk of chunks) {\n    out.set(chunk, offset);\n    offset += chunk.byteLength;\n  }\n  return out;\n}\n\nexport function batchReadableStream(\n  input: ReadableStream<Uint8Array>,\n): ReadableStream<Uint8Array> {\n  const buffer: Uint8Array[] = [];\n  let timer: ReturnType<typeof setTimeout> | undefined;\n\n  const flushBuffer = (\n    controller: TransformStreamDefaultController<Uint8Array>,\n  ): void => {\n    clearTimeout(timer);\n    timer = undefined;\n    if (buffer.length) {\n      try {\n        controller.enqueue(concatUint8Array(buffer));\n      } catch {\n        // ignore errors\n        // ref: https://github.com/wakujs/waku/pull/1863#discussion_r2634546953\n      }\n      buffer.length = 0;\n    }\n  };\n\n  return input.pipeThrough(\n    new TransformStream({\n      transform(chunk, controller) {\n        buffer.push(chunk);\n        if (!timer) {\n          timer = setTimeout(() => flushBuffer(controller));\n        }\n      },\n      flush(controller) {\n        flushBuffer(controller);\n      },\n    }),\n  );\n}\n"],"names":["stringToStream","str","encoder","TextEncoder","ReadableStream","start","controller","enqueue","encode","close","streamToBase64","stream","reader","getReader","binary","result","read","value","Uint8Array","Error","i","length","String","fromCharCode","done","btoa","base64ToStream","base64","bytes","from","atob","c","charCodeAt","Blob","concatUint8Array","chunks","total","reduce","n","chunk","byteLength","out","offset","set","batchReadableStream","input","buffer","timer","flushBuffer","clearTimeout","undefined","pipeThrough","TransformStream","transform","push","setTimeout","flush"],"mappings":"AAAA,0DAA0D;AAE1D,OAAO,MAAMA,iBAAiB,CAACC;IAC7B,MAAMC,UAAU,IAAIC;IACpB,OAAO,IAAIC,eAAe;QACxBC,OAAMC,UAAU;YACdA,WAAWC,OAAO,CAACL,QAAQM,MAAM,CAACP;YAClCK,WAAWG,KAAK;QAClB;IACF;AACF,EAAE;AAEF,OAAO,MAAMC,iBAAiB,OAC5BC;IAEA,MAAMC,SAASD,OAAOE,SAAS;IAC/B,IAAIC,SAAS;IACb,IAAIC;IACJ,GAAG;QACDA,SAAS,MAAMH,OAAOI,IAAI;QAC1B,IAAID,OAAOE,KAAK,EAAE;YAChB,IAAI,CAAEF,CAAAA,OAAOE,KAAK,YAAYC,UAAS,GAAI;gBACzC,MAAM,IAAIC,MAAM;YAClB;YACA,IAAK,IAAIC,IAAI,GAAGA,IAAIL,OAAOE,KAAK,CAACI,MAAM,EAAED,IAAK;gBAC5CN,UAAUQ,OAAOC,YAAY,CAACR,OAAOE,KAAK,CAACG,EAAE;YAC/C;QACF;IACF,QAAS,CAACL,OAAOS,IAAI,CAAE;IACvB,OAAOC,KAAKX;AACd,EAAE;AAEF,OAAO,MAAMY,iBAAiB,CAACC;IAC7B,MAAMC,QAAQV,WAAWW,IAAI,CAACC,KAAKH,SAAS,CAACI,IAAMA,EAAEC,UAAU,CAAC;IAChE,OAAO,IAAIC,KAAK;QAACL;KAAM,EAAEjB,MAAM;AACjC,EAAE;AAEF,SAASuB,iBAAiBC,MAA6B;IACrD,IAAIA,OAAOd,MAAM,KAAK,GAAG;QACvB,OAAOc,MAAM,CAAC,EAAE;IAClB;IACA,MAAMC,QAAQD,OAAOE,MAAM,CAAC,CAACC,GAAGC,QAAUD,IAAIC,MAAMC,UAAU,EAAE;IAChE,MAAMC,MAAM,IAAIvB,WAAWkB;IAC3B,IAAIM,SAAS;IACb,KAAK,MAAMH,SAASJ,OAAQ;QAC1BM,IAAIE,GAAG,CAACJ,OAAOG;QACfA,UAAUH,MAAMC,UAAU;IAC5B;IACA,OAAOC;AACT;AAEA,OAAO,SAASG,oBACdC,KAAiC;IAEjC,MAAMC,SAAuB,EAAE;IAC/B,IAAIC;IAEJ,MAAMC,cAAc,CAClB1C;QAEA2C,aAAaF;QACbA,QAAQG;QACR,IAAIJ,OAAOzB,MAAM,EAAE;YACjB,IAAI;gBACFf,WAAWC,OAAO,CAAC2B,iBAAiBY;YACtC,EAAE,OAAM;YACN,gBAAgB;YAChB,uEAAuE;YACzE;YACAA,OAAOzB,MAAM,GAAG;QAClB;IACF;IAEA,OAAOwB,MAAMM,WAAW,CACtB,IAAIC,gBAAgB;QAClBC,WAAUd,KAAK,EAAEjC,UAAU;YACzBwC,OAAOQ,IAAI,CAACf;YACZ,IAAI,CAACQ,OAAO;gBACVA,QAAQQ,WAAW,IAAMP,YAAY1C;YACvC;QACF;QACAkD,OAAMlD,UAAU;YACd0C,YAAY1C;QACd;IACF;AAEJ"}