import { decodeFuncId, decodeRscPath } from '../utils/rsc-path.js';
import { removeBase } from './path.js';
export async function getInput(req, config, temporaryReferences, decodeReply, decodeAction, decodeFormState, loadServerAction) {
    const url = new URL(req.url);
    url.pathname = removeBase(url.pathname, config.basePath);
    const pathname = decodeURI(url.pathname);
    const rscPathPrefix = '/' + config.rscBase + '/';
    let rscPath;
    let input;
    if (url.pathname.startsWith(rscPathPrefix)) {
        rscPath = decodeRscPath(decodeURI(url.pathname.slice(rscPathPrefix.length)));
        // server action: js
        const actionId = decodeFuncId(rscPath);
        if (actionId) {
            const body = await getActionBody(req);
            const args = await decodeReply(body, {
                temporaryReferences
            });
            const action = await loadServerAction(actionId);
            input = {
                type: 'function',
                fn: action,
                args,
                pathname,
                req
            };
        } else {
            // client RSC request
            let rscParams = url.searchParams;
            if (req.body) {
                const body = await getActionBody(req);
                rscParams = await decodeReply(body, {
                    temporaryReferences
                });
            }
            input = {
                type: 'component',
                rscPath,
                rscParams,
                pathname,
                req
            };
        }
    } else if (req.method === 'POST') {
        const contentType = req.headers.get('content-type');
        if (typeof contentType === 'string' && contentType.startsWith('multipart/form-data')) {
            // server action: no js (progressive enhancement)
            input = {
                type: 'action',
                fn: async ()=>{
                    const formData = await getActionBody(req);
                    const decodedAction = await decodeAction(formData);
                    const result = await decodedAction();
                    return await decodeFormState(result, formData);
                },
                pathname,
                req
            };
        } else {
            // POST API request
            input = {
                type: 'custom',
                pathname,
                req
            };
        }
    } else {
        // SSR
        input = {
            type: 'custom',
            pathname,
            req
        };
    }
    return input;
}
async function getActionBody(req) {
    if (!req.body) {
        throw new Error('missing request body for server function');
    }
    const contentType = req.headers.get('content-type');
    if (contentType?.startsWith('multipart/form-data')) {
        return req.formData();
    } else {
        return req.text();
    }
}

//# sourceMappingURL=request.js.map