{"version":3,"sources":["../../../src/lib/vite-rsc/handler.ts"],"sourcesContent":["import {\n  createFromReadableStream,\n  createTemporaryReferenceSet,\n  decodeAction,\n  decodeFormState,\n  decodeReply,\n  loadServerAction,\n  renderToReadableStream,\n} from '@vitejs/plugin-rsc/rsc';\nimport { buildMetadata } from 'virtual:vite-rsc-waku/build-metadata';\nimport { config, isBuild } from 'virtual:vite-rsc-waku/config';\nimport notFoundHtml from 'virtual:vite-rsc-waku/not-found';\nimport { BUILD_METADATA_FILE, DIST_PUBLIC, DIST_SERVER } from '../constants.js';\nimport { INTERNAL_runWithContext } from '../context.js';\nimport type {\n  Unstable_CreateServerEntryAdapter as CreateServerEntryAdapter,\n  Unstable_HandleBuild as HandleBuild,\n  Unstable_HandleRequest as HandleRequest,\n  Unstable_ProcessBuild as ProcessBuild,\n  Unstable_ProcessRequest as ProcessRequest,\n} from '../types.js';\nimport { getErrorInfo } from '../utils/custom-errors.js';\nimport { joinPath } from '../utils/path.js';\nimport { createRenderUtils } from '../utils/render.js';\nimport { getInput } from '../utils/request.js';\nimport { encodeRscPath } from '../utils/rsc-path.js';\nimport { stringToStream } from '../utils/stream.js';\n\nfunction loadSsrEntryModule() {\n  // This is an API to communicate between two server environments `rsc` and `ssr`.\n  // https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-rsc/README.md#importmetaviterscloadmodule\n  return import.meta.viteRsc.loadModule<\n    typeof import('../vite-entries/entry.ssr.js')\n  >('ssr', 'index');\n}\n\nconst toProcessRequest =\n  (handleRequest: HandleRequest): ProcessRequest =>\n  async (req) => {\n    const temporaryReferences = createTemporaryReferenceSet();\n\n    const input = await getInput(\n      req,\n      config,\n      temporaryReferences,\n      decodeReply,\n      decodeAction,\n      decodeFormState,\n      loadServerAction,\n    );\n\n    const renderUtils = createRenderUtils(\n      temporaryReferences,\n      renderToReadableStream,\n      createFromReadableStream,\n      loadSsrEntryModule,\n    );\n\n    let res: Awaited<ReturnType<typeof handleRequest>>;\n    try {\n      res = await handleRequest(input, {\n        ...renderUtils,\n        loadBuildMetadata: async (key: string) => buildMetadata.get(key),\n      });\n    } catch (e) {\n      const info = getErrorInfo(e);\n      const status = info?.status || 500;\n      const body = stringToStream(\n        (e as { message?: string } | undefined)?.message || String(e),\n      );\n      const headers: { location?: string } = {};\n      if (info?.location) {\n        headers.location = info.location;\n      }\n      return new Response(body, { status, headers });\n    }\n\n    if (res instanceof ReadableStream) {\n      return new Response(res);\n    } else if (res && res !== 'fallback') {\n      return res;\n    }\n\n    // fallback index html like packages/waku/src/lib/plugins/vite-plugin-rsc-index.ts\n    const url = new URL(req.url);\n    if (res === 'fallback' || (!res && url.pathname === '/')) {\n      const { INTERNAL_renderHtmlFallback } = await loadSsrEntryModule();\n      const htmlFallbackStream = await INTERNAL_renderHtmlFallback();\n      const headers = { 'content-type': 'text/html; charset=utf-8' };\n      return new Response(htmlFallbackStream, { headers });\n    }\n\n    return null;\n  };\n\nconst toProcessBuild =\n  (handleBuild: HandleBuild): ProcessBuild =>\n  async ({ emitFile }) => {\n    const renderUtils = createRenderUtils(\n      undefined,\n      renderToReadableStream,\n      createFromReadableStream,\n      loadSsrEntryModule,\n    );\n\n    let fallbackHtml: string | undefined;\n    const getFallbackHtml = async () => {\n      if (!fallbackHtml) {\n        const ssrEntryModule = await loadSsrEntryModule();\n        fallbackHtml = await ssrEntryModule.INTERNAL_renderHtmlFallback();\n      }\n      return fallbackHtml;\n    };\n\n    const buildMetadata = new Map<string, string>();\n\n    await handleBuild({\n      renderRsc: renderUtils.renderRsc,\n      parseRsc: renderUtils.parseRsc,\n      renderHtml: renderUtils.renderHtml,\n      rscPath2pathname: (rscPath) =>\n        joinPath(config.rscBase, encodeRscPath(rscPath)),\n      saveBuildMetadata: async (key, value) => {\n        buildMetadata.set(key, value);\n      },\n      withRequest: (req, fn) => INTERNAL_runWithContext(req, fn),\n      generateFile: async (fileName, body) => {\n        await emitFile(joinPath(DIST_PUBLIC, fileName), body);\n      },\n      generateDefaultHtml: async (fileName) => {\n        await emitFile(\n          joinPath(DIST_PUBLIC, fileName),\n          await getFallbackHtml(),\n        );\n      },\n    });\n\n    await emitFile(\n      joinPath(DIST_SERVER, BUILD_METADATA_FILE),\n      `export const buildMetadata = new Map(${JSON.stringify(Array.from(buildMetadata))});`,\n    );\n  };\n\nexport const createServerEntryAdapter: CreateServerEntryAdapter =\n  (fn) =>\n  ({ handleRequest, handleBuild }, options) => {\n    const processRequest = toProcessRequest(handleRequest);\n    const processBuild = toProcessBuild(handleBuild);\n    return fn(\n      {\n        processRequest,\n        processBuild,\n        config,\n        isBuild,\n        notFoundHtml,\n      },\n      options,\n    );\n  };\n"],"names":["createFromReadableStream","createTemporaryReferenceSet","decodeAction","decodeFormState","decodeReply","loadServerAction","renderToReadableStream","buildMetadata","config","isBuild","notFoundHtml","BUILD_METADATA_FILE","DIST_PUBLIC","DIST_SERVER","INTERNAL_runWithContext","getErrorInfo","joinPath","createRenderUtils","getInput","encodeRscPath","stringToStream","loadSsrEntryModule","viteRsc","loadModule","toProcessRequest","handleRequest","req","temporaryReferences","input","renderUtils","res","loadBuildMetadata","key","get","e","info","status","body","message","String","headers","location","Response","ReadableStream","url","URL","pathname","INTERNAL_renderHtmlFallback","htmlFallbackStream","toProcessBuild","handleBuild","emitFile","undefined","fallbackHtml","getFallbackHtml","ssrEntryModule","Map","renderRsc","parseRsc","renderHtml","rscPath2pathname","rscPath","rscBase","saveBuildMetadata","value","set","withRequest","fn","generateFile","fileName","generateDefaultHtml","JSON","stringify","Array","from","createServerEntryAdapter","options","processRequest","processBuild"],"mappings":"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"}