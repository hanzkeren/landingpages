{"version":3,"sources":["../../../src/lib/vite-rsc/cli.ts"],"sourcesContent":["import { existsSync } from 'node:fs';\nimport net from 'node:net';\nimport path from 'node:path';\nimport { pathToFileURL } from 'node:url';\nimport * as vite from 'vite';\nimport type { Config } from '../../config.js';\nimport { resolveConfig } from '../utils/config.js';\nimport { rscPlugin } from './plugin.js';\n\nasync function loadConfig(): Promise<Required<Config>> {\n  let config: Config | undefined;\n  if (existsSync('waku.config.ts') || existsSync('waku.config.js')) {\n    const imported = await vite.runnerImport<{ default: Config }>(\n      '/waku.config',\n    );\n    config = imported.module.default;\n  }\n  return resolveConfig(config);\n}\n\nasync function startDevServer(\n  host: string | undefined,\n  port: number,\n  config: Required<Config>,\n) {\n  const server = await vite.createServer({\n    configFile: false,\n    plugins: [rscPlugin(config)],\n    server: host ? { host, port } : { port },\n  });\n  await server.listen();\n  const url =\n    server.resolvedUrls?.network?.[0] ?? server.resolvedUrls?.local?.[0];\n  console.log(`ready: Listening on ${url}`);\n  const watcher = server.watcher;\n  watcher.on('change', handleConfigChange);\n  watcher.on('unlink', handleConfigChange);\n  watcher.on('add', handleConfigChange);\n\n  async function handleConfigChange(changedFile: string) {\n    const dirname = path.dirname(changedFile);\n    const filename = path.basename(changedFile);\n    if (\n      dirname === process.cwd() &&\n      (filename === 'waku.config.ts' || filename === 'waku.config.js')\n    ) {\n      console.log(`Waku configuration file changed, restarting server...`);\n      await server.close();\n      const config = await loadConfig();\n      await startDevServer(host, port, config);\n    }\n  }\n}\n\nexport async function cli(\n  cmd: 'dev' | 'build' | 'start',\n  flags: { host?: string; port?: string },\n) {\n  // set NODE_ENV before runnerImport https://github.com/vitejs/vite/issues/20299\n  const nodeEnv = cmd === 'dev' ? 'development' : 'production';\n  if (process.env.NODE_ENV && process.env.NODE_ENV !== nodeEnv) {\n    console.warn(\n      `Warning: NODE_ENV is set to '${process.env.NODE_ENV}', but overriding it to '${nodeEnv}'.`,\n    );\n  }\n  process.env.NODE_ENV = nodeEnv;\n\n  const config = await loadConfig();\n\n  if (cmd === 'dev') {\n    const host = flags.host;\n    const port = parseInt(flags.port || '3000', 10);\n    await startDevServer(host, port, config);\n  } else if (cmd === 'build') {\n    const builder = await vite.createBuilder({\n      configFile: false,\n      plugins: [rscPlugin(config)],\n    });\n    await builder.buildApp();\n  } else if (cmd === 'start') {\n    const host = flags.host;\n    const port = await getFreePort(parseInt(flags.port || '8080', 10));\n    const distDir = config?.distDir ?? 'dist';\n    const serveFileUrl = pathToFileURL(\n      path.resolve(distDir, 'serve-node.js'),\n    ).href;\n    if (host) {\n      process.env.HOST = host;\n    }\n    process.env.PORT = String(port);\n    await import(serveFileUrl);\n    console.log(`ready: Listening on http://${host || 'localhost'}:${port}/`);\n  }\n}\n\nasync function getFreePort(startPort: number): Promise<number> {\n  for (let port = startPort; ; port++) {\n    try {\n      await new Promise<void>((resolve, reject) => {\n        const srv = net\n          .createServer()\n          .once('error', reject)\n          .once('listening', () => srv.close(() => resolve()))\n          .listen(port);\n      });\n      return port;\n    } catch (err) {\n      if ((err as NodeJS.ErrnoException).code !== 'EADDRINUSE') {\n        throw err;\n      }\n    }\n  }\n}\n"],"names":["existsSync","net","path","pathToFileURL","vite","resolveConfig","rscPlugin","loadConfig","config","imported","runnerImport","module","default","startDevServer","host","port","server","createServer","configFile","plugins","listen","url","resolvedUrls","network","local","console","log","watcher","on","handleConfigChange","changedFile","dirname","filename","basename","process","cwd","close","cli","cmd","flags","nodeEnv","env","NODE_ENV","warn","parseInt","builder","createBuilder","buildApp","getFreePort","distDir","serveFileUrl","resolve","href","HOST","PORT","String","startPort","Promise","reject","srv","once","err","code"],"mappings":"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"}