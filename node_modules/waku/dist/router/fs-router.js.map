{"version":3,"sources":["../../src/router/fs-router.ts"],"sourcesContent":["import type { FunctionComponent, ReactNode } from 'react';\nimport type { ImportGlobFunction } from 'vite/types/importGlob.d.ts';\nimport { isIgnoredPath } from '../lib/utils/fs-router.js';\nimport { METHODS, createPages } from './create-pages.js';\nimport type { Method } from './create-pages.js';\n\ndeclare global {\n  interface ImportMeta {\n    glob: ImportGlobFunction;\n  }\n}\n\nexport function fsRouter(\n  /**\n   * A mapping from a file path to a route module, e.g.\n   *   {\n   *     \"_layout.tsx\": () => ({ default: ... }),\n   *     \"index.tsx\": () => ({ default: ... }),\n   *     \"foo/index.tsx\": () => ...,\n   *   }\n   * This mapping can be created by Vite's import.meta.glob, e.g.\n   *   import.meta.glob(\"./**\\/*.{tsx,ts}\", { base: \"./pages\" })\n   */\n  pages: { [file: string]: () => Promise<unknown> },\n  options: {\n    /** e.g. `\"api\"` will detect pages in `src/pages/api`. */\n    apiDir: string;\n    /** e.g. `\"_slices\"` will detect slices in `src/pages/_slices`. */\n    slicesDir: string;\n  } = {\n    apiDir: 'api',\n    slicesDir: '_slices',\n  },\n) {\n  return createPages(\n    async ({\n      createPage,\n      createLayout,\n      createRoot,\n      createApi,\n      createSlice,\n    }) => {\n      for (let file in pages) {\n        const mod = (await pages[file]!()) as {\n          default: FunctionComponent<{ children: ReactNode }>;\n          getConfig?: () => Promise<{\n            render?: 'static' | 'dynamic';\n          }>;\n          GET?: (req: Request) => Promise<Response>;\n        };\n        // strip \"./\" prefix\n        file = file.replace(/^\\.\\//, '');\n        const config = await mod.getConfig?.();\n        const pathItems = file\n          .replace(/\\.\\w+$/, '')\n          .split('/')\n          .filter(Boolean);\n        if (isIgnoredPath(pathItems)) {\n          continue;\n        }\n        const path =\n          '/' +\n          (['_layout', 'index', '_root'].includes(pathItems.at(-1)!) ||\n          pathItems.at(-1)?.startsWith('_part')\n            ? pathItems.slice(0, -1)\n            : pathItems\n          ).join('/');\n        if (pathItems.at(-1) === '[path]') {\n          throw new Error(\n            'Page file cannot be named [path]. This will conflict with the path prop of the page component.',\n          );\n        } else if (pathItems.at(0) === options.apiDir) {\n          if (config?.render === 'static') {\n            if (Object.keys(mod).length !== 2 || !mod.GET) {\n              console.warn(\n                `API ${path} is invalid. For static API routes, only a single GET handler is supported.`,\n              );\n            }\n            createApi({\n              ...config,\n              path: pathItems.join('/'),\n              render: 'static',\n              method: 'GET',\n              handler: mod.GET!,\n            });\n          } else {\n            const validMethods = new Set(METHODS);\n            const handlers = Object.fromEntries(\n              Object.entries(mod).flatMap(([exportName, handler]) => {\n                const isValidExport =\n                  exportName === 'getConfig' ||\n                  exportName === 'default' ||\n                  validMethods.has(exportName as Method);\n                if (!isValidExport) {\n                  console.warn(\n                    `API ${path} has an invalid export: ${exportName}. Valid exports are: ${METHODS.join(\n                      ', ',\n                    )}`,\n                  );\n                }\n                return isValidExport && exportName !== 'getConfig'\n                  ? exportName === 'default'\n                    ? [['all', handler]]\n                    : [[exportName, handler]]\n                  : [];\n              }),\n            );\n            createApi({\n              path: pathItems.join('/'),\n              render: 'dynamic',\n              handlers,\n            });\n          }\n        } else if (pathItems.at(0) === options.slicesDir) {\n          createSlice({\n            component: mod.default,\n            render: 'static',\n            id: pathItems.slice(1).join('/'),\n            ...config,\n          });\n        } else if (pathItems.at(-1) === '_layout') {\n          createLayout({\n            path,\n            component: mod.default,\n            render: 'static',\n            ...config,\n          });\n        } else if (pathItems.at(-1) === '_root') {\n          createRoot({\n            component: mod.default,\n            render: 'static',\n            ...config,\n          });\n        } else {\n          createPage({\n            path,\n            component: mod.default,\n            render: 'static',\n            ...config,\n          } as never); // FIXME avoid as never\n        }\n      }\n      // HACK: to satisfy the return type, unused at runtime\n      return null as never;\n    },\n  );\n}\n"],"names":["isIgnoredPath","METHODS","createPages","fsRouter","pages","options","apiDir","slicesDir","createPage","createLayout","createRoot","createApi","createSlice","file","mod","replace","config","getConfig","pathItems","split","filter","Boolean","path","includes","at","startsWith","slice","join","Error","render","Object","keys","length","GET","console","warn","method","handler","validMethods","Set","handlers","fromEntries","entries","flatMap","exportName","isValidExport","has","component","default","id"],"mappings":"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"}