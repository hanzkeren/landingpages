{"version":3,"sources":["../../src/adapters/vercel-build-enhancer.ts"],"sourcesContent":["import { cpSync, existsSync, mkdirSync, rmSync, writeFileSync } from 'node:fs';\nimport path from 'node:path';\n\nexport type BuildOptions = {\n  assetsDir: string;\n  distDir: string;\n  rscBase: string;\n  privateDir: string;\n  basePath: string;\n  DIST_PUBLIC: string;\n  serverless: boolean;\n};\n\nasync function postBuild({\n  assetsDir,\n  distDir,\n  rscBase,\n  privateDir,\n  basePath,\n  DIST_PUBLIC,\n  serverless,\n}: BuildOptions) {\n  const SERVE_JS = 'serve-vercel.js';\n  const serveCode = `\nimport { INTERNAL_runFetch } from './server/index.js';\n\nconst getRequestListener = globalThis.__WAKU_HONO_NODE_SERVER_GET_REQUEST_LISTENER__;\n\nexport default getRequestListener(\n  (req, ...args) => INTERNAL_runFetch(process.env, req, ...args)\n);\n`;\n  const publicDir = path.resolve(distDir, DIST_PUBLIC);\n  const outputDir = path.resolve('.vercel', 'output');\n  cpSync(publicDir, path.join(outputDir, 'static'), { recursive: true });\n\n  if (serverless) {\n    // for serverless function\n    // TODO(waku): can use `@vercel/nft` to packaging with native dependencies\n    const serverlessDir = path.join(outputDir, 'functions', rscBase + '.func');\n    rmSync(serverlessDir, { recursive: true, force: true });\n    mkdirSync(path.join(serverlessDir, distDir), {\n      recursive: true,\n    });\n    writeFileSync(path.resolve(distDir, SERVE_JS), serveCode);\n    cpSync(path.resolve(distDir), path.join(serverlessDir, distDir), {\n      recursive: true,\n    });\n    if (existsSync(path.resolve(privateDir))) {\n      cpSync(path.resolve(privateDir), path.join(serverlessDir, privateDir), {\n        recursive: true,\n        dereference: true,\n      });\n    }\n    const vcConfigJson = {\n      runtime: 'nodejs22.x',\n      handler: `${distDir}/${SERVE_JS}`,\n      launcherType: 'Nodejs',\n    };\n    writeFileSync(\n      path.join(serverlessDir, '.vc-config.json'),\n      JSON.stringify(vcConfigJson, null, 2),\n    );\n    writeFileSync(\n      path.join(serverlessDir, 'package.json'),\n      JSON.stringify({ type: 'module' }, null, 2),\n    );\n  }\n  const routes = [\n    {\n      src: `^${basePath}${assetsDir}/(.*)$`,\n      headers: {\n        'cache-control': 'public, immutable, max-age=31536000',\n      },\n    },\n    ...(serverless\n      ? [\n          { handle: 'filesystem' },\n          {\n            src: basePath + '(.*)',\n            dest: basePath + rscBase + '/',\n          },\n        ]\n      : []),\n  ];\n  const configJson = { version: 3, routes };\n  mkdirSync(outputDir, { recursive: true });\n  writeFileSync(\n    path.join(outputDir, 'config.json'),\n    JSON.stringify(configJson, null, 2),\n  );\n}\n\nexport default async function buildEnhancer(\n  build: (utils: unknown, options: BuildOptions) => Promise<void>,\n): Promise<typeof build> {\n  return async (utils: unknown, options: BuildOptions) => {\n    await build(utils, options);\n    await postBuild(options);\n  };\n}\n"],"names":["cpSync","existsSync","mkdirSync","rmSync","writeFileSync","path","postBuild","assetsDir","distDir","rscBase","privateDir","basePath","DIST_PUBLIC","serverless","SERVE_JS","serveCode","publicDir","resolve","outputDir","join","recursive","serverlessDir","force","dereference","vcConfigJson","runtime","handler","launcherType","JSON","stringify","type","routes","src","headers","handle","dest","configJson","version","buildEnhancer","build","utils","options"],"mappings":"AAAA,SAASA,MAAM,EAAEC,UAAU,EAAEC,SAAS,EAAEC,MAAM,EAAEC,aAAa,QAAQ,UAAU;AAC/E,OAAOC,UAAU,YAAY;AAY7B,eAAeC,UAAU,EACvBC,SAAS,EACTC,OAAO,EACPC,OAAO,EACPC,UAAU,EACVC,QAAQ,EACRC,WAAW,EACXC,UAAU,EACG;IACb,MAAMC,WAAW;IACjB,MAAMC,YAAY,CAAC;;;;;;;;AAQrB,CAAC;IACC,MAAMC,YAAYX,KAAKY,OAAO,CAACT,SAASI;IACxC,MAAMM,YAAYb,KAAKY,OAAO,CAAC,WAAW;IAC1CjB,OAAOgB,WAAWX,KAAKc,IAAI,CAACD,WAAW,WAAW;QAAEE,WAAW;IAAK;IAEpE,IAAIP,YAAY;QACd,0BAA0B;QAC1B,0EAA0E;QAC1E,MAAMQ,gBAAgBhB,KAAKc,IAAI,CAACD,WAAW,aAAaT,UAAU;QAClEN,OAAOkB,eAAe;YAAED,WAAW;YAAME,OAAO;QAAK;QACrDpB,UAAUG,KAAKc,IAAI,CAACE,eAAeb,UAAU;YAC3CY,WAAW;QACb;QACAhB,cAAcC,KAAKY,OAAO,CAACT,SAASM,WAAWC;QAC/Cf,OAAOK,KAAKY,OAAO,CAACT,UAAUH,KAAKc,IAAI,CAACE,eAAeb,UAAU;YAC/DY,WAAW;QACb;QACA,IAAInB,WAAWI,KAAKY,OAAO,CAACP,cAAc;YACxCV,OAAOK,KAAKY,OAAO,CAACP,aAAaL,KAAKc,IAAI,CAACE,eAAeX,aAAa;gBACrEU,WAAW;gBACXG,aAAa;YACf;QACF;QACA,MAAMC,eAAe;YACnBC,SAAS;YACTC,SAAS,GAAGlB,QAAQ,CAAC,EAAEM,UAAU;YACjCa,cAAc;QAChB;QACAvB,cACEC,KAAKc,IAAI,CAACE,eAAe,oBACzBO,KAAKC,SAAS,CAACL,cAAc,MAAM;QAErCpB,cACEC,KAAKc,IAAI,CAACE,eAAe,iBACzBO,KAAKC,SAAS,CAAC;YAAEC,MAAM;QAAS,GAAG,MAAM;IAE7C;IACA,MAAMC,SAAS;QACb;YACEC,KAAK,CAAC,CAAC,EAAErB,WAAWJ,UAAU,MAAM,CAAC;YACrC0B,SAAS;gBACP,iBAAiB;YACnB;QACF;WACIpB,aACA;YACE;gBAAEqB,QAAQ;YAAa;YACvB;gBACEF,KAAKrB,WAAW;gBAChBwB,MAAMxB,WAAWF,UAAU;YAC7B;SACD,GACD,EAAE;KACP;IACD,MAAM2B,aAAa;QAAEC,SAAS;QAAGN;IAAO;IACxC7B,UAAUgB,WAAW;QAAEE,WAAW;IAAK;IACvChB,cACEC,KAAKc,IAAI,CAACD,WAAW,gBACrBU,KAAKC,SAAS,CAACO,YAAY,MAAM;AAErC;AAEA,eAAe,eAAeE,cAC5BC,KAA+D;IAE/D,OAAO,OAAOC,OAAgBC;QAC5B,MAAMF,MAAMC,OAAOC;QACnB,MAAMnC,UAAUmC;IAClB;AACF"}