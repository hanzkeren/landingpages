{"version":3,"sources":["../../src/adapters/cloudflare-build-enhancer.ts"],"sourcesContent":["import fs from 'node:fs';\nimport path from 'node:path';\n\nexport type BuildOptions = { distDir: string };\n\nasync function postBuild({ distDir }: BuildOptions) {\n  const mainEntry = path.resolve(\n    path.join(distDir, 'server', 'serve-cloudflare.js'),\n  );\n  fs.writeFileSync(\n    mainEntry,\n    `\\\nimport { INTERNAL_runFetch } from './index.js';\n\nexport default {\n  fetch: (request, env, ctx) => INTERNAL_runFetch(env, request, env, ctx),\n};\n`,\n  );\n\n  const wranglerTomlFile = path.resolve('wrangler.toml');\n  const wranglerJsonFile = path.resolve('wrangler.json');\n  const wranglerJsoncFile = path.resolve('wrangler.jsonc');\n  if (\n    !fs.existsSync(wranglerTomlFile) &&\n    !fs.existsSync(wranglerJsonFile) &&\n    !fs.existsSync(wranglerJsoncFile)\n  ) {\n    fs.writeFileSync(\n      wranglerJsoncFile,\n      `\\\n{\n  \"name\": \"waku-project\",\n  \"main\": ${JSON.stringify(forceRelativePath(path.relative(process.cwd(), mainEntry)))},\n  // https://developers.cloudflare.com/workers/platform/compatibility-dates\n  \"compatibility_date\": \"2024-11-11\",\n  // nodejs_als is required for Waku server-side request context\n  // It can be removed if only building static pages\n  \"compatibility_flags\": [\"nodejs_als\"],\n  // https://developers.cloudflare.com/workers/static-assets/binding/\n  \"assets\": {\n    \"binding\": \"ASSETS\",\n    \"directory\": \"./dist/public\",\n    \"html_handling\": \"drop-trailing-slash\",\n    \"not_found_handling\": \"404-page\"\n  }\n}\n`,\n    );\n  }\n}\n\nexport default async function buildEnhancer(\n  build: (utils: unknown, options: BuildOptions) => Promise<void>,\n): Promise<typeof build> {\n  return async (utils: unknown, options: BuildOptions) => {\n    await build(utils, options);\n    await postBuild(options);\n  };\n}\n\nconst forceRelativePath = (s: string) => (s.startsWith('.') ? s : './' + s);\n"],"names":["fs","path","postBuild","distDir","mainEntry","resolve","join","writeFileSync","wranglerTomlFile","wranglerJsonFile","wranglerJsoncFile","existsSync","JSON","stringify","forceRelativePath","relative","process","cwd","buildEnhancer","build","utils","options","s","startsWith"],"mappings":"AAAA,OAAOA,QAAQ,UAAU;AACzB,OAAOC,UAAU,YAAY;AAI7B,eAAeC,UAAU,EAAEC,OAAO,EAAgB;IAChD,MAAMC,YAAYH,KAAKI,OAAO,CAC5BJ,KAAKK,IAAI,CAACH,SAAS,UAAU;IAE/BH,GAAGO,aAAa,CACdH,WACA,CAAC;;;;;;AAML,CAAC;IAGC,MAAMI,mBAAmBP,KAAKI,OAAO,CAAC;IACtC,MAAMI,mBAAmBR,KAAKI,OAAO,CAAC;IACtC,MAAMK,oBAAoBT,KAAKI,OAAO,CAAC;IACvC,IACE,CAACL,GAAGW,UAAU,CAACH,qBACf,CAACR,GAAGW,UAAU,CAACF,qBACf,CAACT,GAAGW,UAAU,CAACD,oBACf;QACAV,GAAGO,aAAa,CACdG,mBACA,CAAC;;;UAGG,EAAEE,KAAKC,SAAS,CAACC,kBAAkBb,KAAKc,QAAQ,CAACC,QAAQC,GAAG,IAAIb,aAAa;;;;;;;;;;;;;;AAcvF,CAAC;IAEC;AACF;AAEA,eAAe,eAAec,cAC5BC,KAA+D;IAE/D,OAAO,OAAOC,OAAgBC;QAC5B,MAAMF,MAAMC,OAAOC;QACnB,MAAMnB,UAAUmB;IAClB;AACF;AAEA,MAAMP,oBAAoB,CAACQ,IAAeA,EAAEC,UAAU,CAAC,OAAOD,IAAI,OAAOA"}