{"version":3,"sources":["../../src/adapters/deno.ts"],"sourcesContent":["import path from 'node:path';\n// FIXME hopefully we should avoid bundling this\nimport { Hono as HonoForDevAndBuild } from 'hono';\nimport type { MiddlewareHandler } from 'hono';\nimport {\n  unstable_constants as constants,\n  unstable_createServerEntryAdapter as createServerEntryAdapter,\n  unstable_honoMiddleware as honoMiddleware,\n} from 'waku/internals';\nimport type { BuildOptions } from './deno-build-enhancer.js';\n\nconst { DIST_PUBLIC } = constants;\nconst { contextMiddleware, rscMiddleware, middlewareRunner } = honoMiddleware;\n\nexport default createServerEntryAdapter(\n  (\n    { processRequest, processBuild, config, notFoundHtml },\n    options?: {\n      middlewareFns?: (() => MiddlewareHandler)[];\n      middlewareModules?: Record<string, () => Promise<unknown>>;\n    },\n  ) => {\n    const { middlewareFns = [], middlewareModules = {} } = options || {};\n    const {\n      __WAKU_DENO_ADAPTER_HONO__: Hono = HonoForDevAndBuild,\n      __WAKU_DENO_ADAPTER_SERVE_STATIC__: serveStatic,\n    } = globalThis as any;\n    const app = new Hono();\n    app.notFound((c: any) => {\n      if (notFoundHtml) {\n        return c.html(notFoundHtml, 404);\n      }\n      return c.text('404 Not Found', 404);\n    });\n    if (serveStatic) {\n      app.use(serveStatic({ root: path.join(config.distDir, DIST_PUBLIC) }));\n    }\n    app.use(contextMiddleware());\n    for (const middlewareFn of middlewareFns) {\n      app.use(middlewareFn());\n    }\n    app.use(middlewareRunner(middlewareModules as never));\n    app.use(rscMiddleware({ processRequest }));\n    const buildOptions: BuildOptions = {\n      distDir: config.distDir,\n    };\n    return {\n      fetch: app.fetch,\n      build: processBuild,\n      buildOptions,\n      buildEnhancers: ['waku/adapters/deno-build-enhancer'],\n    };\n  },\n);\n"],"names":["path","Hono","HonoForDevAndBuild","unstable_constants","constants","unstable_createServerEntryAdapter","createServerEntryAdapter","unstable_honoMiddleware","honoMiddleware","DIST_PUBLIC","contextMiddleware","rscMiddleware","middlewareRunner","processRequest","processBuild","config","notFoundHtml","options","middlewareFns","middlewareModules","__WAKU_DENO_ADAPTER_HONO__","__WAKU_DENO_ADAPTER_SERVE_STATIC__","serveStatic","globalThis","app","notFound","c","html","text","use","root","join","distDir","middlewareFn","buildOptions","fetch","build","buildEnhancers"],"mappings":"AAAA,OAAOA,UAAU,YAAY;AAC7B,gDAAgD;AAChD,SAASC,QAAQC,kBAAkB,QAAQ,OAAO;AAElD,SACEC,sBAAsBC,SAAS,EAC/BC,qCAAqCC,wBAAwB,EAC7DC,2BAA2BC,cAAc,QACpC,iBAAiB;AAGxB,MAAM,EAAEC,WAAW,EAAE,GAAGL;AACxB,MAAM,EAAEM,iBAAiB,EAAEC,aAAa,EAAEC,gBAAgB,EAAE,GAAGJ;AAE/D,eAAeF,yBACb,CACE,EAAEO,cAAc,EAAEC,YAAY,EAAEC,MAAM,EAAEC,YAAY,EAAE,EACtDC;IAKA,MAAM,EAAEC,gBAAgB,EAAE,EAAEC,oBAAoB,CAAC,CAAC,EAAE,GAAGF,WAAW,CAAC;IACnE,MAAM,EACJG,4BAA4BnB,OAAOC,kBAAkB,EACrDmB,oCAAoCC,WAAW,EAChD,GAAGC;IACJ,MAAMC,MAAM,IAAIvB;IAChBuB,IAAIC,QAAQ,CAAC,CAACC;QACZ,IAAIV,cAAc;YAChB,OAAOU,EAAEC,IAAI,CAACX,cAAc;QAC9B;QACA,OAAOU,EAAEE,IAAI,CAAC,iBAAiB;IACjC;IACA,IAAIN,aAAa;QACfE,IAAIK,GAAG,CAACP,YAAY;YAAEQ,MAAM9B,KAAK+B,IAAI,CAAChB,OAAOiB,OAAO,EAAEvB;QAAa;IACrE;IACAe,IAAIK,GAAG,CAACnB;IACR,KAAK,MAAMuB,gBAAgBf,cAAe;QACxCM,IAAIK,GAAG,CAACI;IACV;IACAT,IAAIK,GAAG,CAACjB,iBAAiBO;IACzBK,IAAIK,GAAG,CAAClB,cAAc;QAAEE;IAAe;IACvC,MAAMqB,eAA6B;QACjCF,SAASjB,OAAOiB,OAAO;IACzB;IACA,OAAO;QACLG,OAAOX,IAAIW,KAAK;QAChBC,OAAOtB;QACPoB;QACAG,gBAAgB;YAAC;SAAoC;IACvD;AACF,GACA"}